# RAG 技术详解

## 什么是 RAG？

RAG（Retrieval-Augmented Generation，检索增强生成）是一种结合了信息检索和文本生成的技术，用于提高大语言模型回答的准确性和时效性。

## 为什么需要 RAG？

大语言模型存在以下局限：

1. **知识截止**：训练数据有时间限制
2. **幻觉问题**：可能编造不存在的信息
3. **领域知识**：通用模型在专业领域表现有限
4. **隐私数据**：无法访问企业内部知识

RAG 通过检索外部知识库，让 LLM 基于真实数据生成回答，有效解决上述问题。

## RAG 工作原理

### 索引阶段

1. **文档收集**：收集相关文档
2. **预处理**：清洗、格式化
3. **分块**：将文档切分为适当大小的片段
4. **向量化**：使用 Embedding 模型转换为向量
5. **存储**：保存到向量数据库

### 检索阶段

1. **查询处理**：对用户问题进行预处理
2. **向量化**：将问题转换为向量
3. **相似度搜索**：在向量库中检索相似文档
4. **重排序**：对结果进行精排

### 生成阶段

1. **上下文组装**：将检索到的文档与问题组合
2. **提示构建**：构建完整的提示词
3. **LLM 生成**：调用语言模型生成回答
4. **后处理**：格式化输出

## 文档分块策略

### 固定大小分块

最简单的方法，按固定字符数切分：

```python
from langchain.text_splitter import CharacterTextSplitter

splitter = CharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=100
)
```

### 递归分块

按层次结构分割，更智能：

```python
from langchain.text_splitter import RecursiveCharacterTextSplitter

splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=100,
    separators=["\n\n", "\n", "。", " "]
)
```

### 语义分块

基于语义相似度分块，保持语义完整性。

## 检索策略

### 向量检索

基于语义相似度的检索：

- 优点：理解语义，支持模糊匹配
- 缺点：可能遗漏关键词

### 关键词检索（BM25）

基于词频的传统检索：

- 优点：精确匹配关键词
- 缺点：无法理解同义词

### 混合检索

结合向量检索和关键词检索的优点。

## 评估指标

### 检索质量

- **召回率**：相关文档被检索到的比例
- **精确率**：检索结果中相关文档的比例
- **MRR**：相关结果的平均倒数排名

### 生成质量

- **答案相关性**：回答是否切题
- **忠实度**：回答是否基于检索内容
- **有用性**：回答对用户是否有帮助

## 优化技巧

1. **查询改写**：扩展或精炼用户问题
2. **多路检索**：使用不同策略并融合结果
3. **重排序**：用更精确的模型对结果重排
4. **上下文压缩**：过滤无关内容

## 常见问题

Q: chunk_size 设置多大合适？
A: 通常 500-1000 字符，具体需根据文档特点调整。

Q: 检索多少条文档？
A: 通常 3-10 条，太少信息不够，太多增加干扰。

Q: 如何处理长文档？
A: 建议分层检索，先定位章节再检索段落。
