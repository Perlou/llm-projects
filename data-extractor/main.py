#!/usr/bin/env python3
"""
ç»“æ„åŒ–æ•°æ®æå–å™¨ - ä¸»å…¥å£
åŸºäº LangChain + Gemini çš„ä¿¡æ¯æå–å·¥å…·

è¿è¡Œï¼špython main.py
"""

import sys
import json
from datetime import datetime
from pathlib import Path

from config import OUTPUT_DIR
from extractors import LangChainExtractor
from utils import Display


# æå–æ¨¡å¼é…ç½®
MODES = [
    ("resume", "ğŸ“‹ ç®€å†ä¿¡æ¯æå–", "ä»ç®€å†æ–‡æœ¬æå–ä¸ªäººä¿¡æ¯ã€æ•™è‚²å’Œå·¥ä½œç»å†"),
    ("contract", "ğŸ“„ åˆåŒæ¡æ¬¾æå–", "ä»åˆåŒæ–‡æœ¬æå–å…³é”®æ¡æ¬¾å’Œä¿¡æ¯"),
    ("news", "ğŸ“° æ–°é—»äº‹ä»¶æŠ½å–", "ä»æ–°é—»æ–‡æœ¬æå–äº‹ä»¶ã€äººç‰©ã€æ—¶é—´åœ°ç‚¹"),
    ("review", "ğŸ’¬ è¯„è®ºæƒ…æ„Ÿåˆ†æ", "åˆ†æäº§å“è¯„è®ºçš„æƒ…æ„Ÿå€¾å‘å’Œå…³é”®ç‚¹"),
]

# ç¤ºä¾‹æ–‡æœ¬
EXAMPLES = {
    "resume": """å¼ ä¸‰ï¼Œç”·ï¼Œ1990å¹´5æœˆå‡ºç”ŸäºåŒ—äº¬å¸‚æµ·æ·€åŒº
æ‰‹æœºï¼š13812345678ï¼Œé‚®ç®±ï¼šzhangsan@email.com

æ•™è‚²èƒŒæ™¯ï¼š
2008-2012 åŒ—äº¬å¤§å­¦ è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸š æœ¬ç§‘
2012-2015 æ¸…åå¤§å­¦ è½¯ä»¶å·¥ç¨‹ä¸“ä¸š ç¡•å£«

å·¥ä½œç»å†ï¼š
2015-2018 ç™¾åº¦å…¬å¸ è½¯ä»¶å·¥ç¨‹å¸ˆ
è´Ÿè´£æœç´¢å¼•æ“æ ¸å¿ƒç®—æ³•ä¼˜åŒ–

2018-2022 å­—èŠ‚è·³åŠ¨ é«˜çº§å·¥ç¨‹å¸ˆ
è´Ÿè´£æ¨èç³»ç»Ÿæ¶æ„è®¾è®¡

2022-è‡³ä»Š é˜¿é‡Œå·´å·´ æŠ€æœ¯ä¸“å®¶
è´Ÿè´£å¤§æ•°æ®å¹³å°å»ºè®¾

æŠ€èƒ½ï¼šPythonã€Javaã€æœºå™¨å­¦ä¹ ã€åˆ†å¸ƒå¼ç³»ç»Ÿ""",
    "contract": """é‡‡è´­åˆåŒ

ç”²æ–¹ï¼šåŒ—äº¬ç§‘æŠ€æœ‰é™å…¬å¸ï¼ˆä¹°æ–¹ï¼‰
æ³•å®šä»£è¡¨äººï¼šææ˜

ä¹™æ–¹ï¼šä¸Šæµ·ç”µå­è®¾å¤‡æœ‰é™å…¬å¸ï¼ˆå–æ–¹ï¼‰
æ³•å®šä»£è¡¨äººï¼šç‹èŠ³

ä¸€ã€åˆåŒæ ‡çš„
ä¹™æ–¹å‘ç”²æ–¹æä¾›æœåŠ¡å™¨è®¾å¤‡100å°ã€‚

äºŒã€åˆåŒé‡‘é¢
æ€»é‡‘é¢äººæ°‘å¸500ä¸‡å…ƒæ•´ã€‚

ä¸‰ã€ä»˜æ¬¾æ–¹å¼
åˆåŒç­¾è®¢åæ”¯ä»˜30%ï¼ŒéªŒæ”¶åˆæ ¼åæ”¯ä»˜70%ã€‚

å››ã€äº¤ä»˜æ—¶é—´
2024å¹´3æœˆ1æ—¥å‰å®Œæˆäº¤ä»˜ã€‚

äº”ã€è´¨ä¿æœŸé™
è®¾å¤‡è´¨ä¿æœŸä¸º3å¹´ã€‚

å…­ã€è¿çº¦è´£ä»»
ä»»ä½•ä¸€æ–¹è¿çº¦ï¼Œéœ€æ”¯ä»˜åˆåŒæ€»é¢10%çš„è¿çº¦é‡‘ã€‚

æœ¬åˆåŒè‡ª2024å¹´1æœˆ15æ—¥èµ·ç”Ÿæ•ˆï¼Œæœ‰æ•ˆæœŸè‡³2027å¹´1æœˆ14æ—¥ã€‚""",
    "news": """OpenAIä»Šæ—¥å®£å¸ƒæ¨å‡ºGPT-5æ¨¡å‹

2024å¹´1æœˆ20æ—¥ï¼Œæ—§é‡‘å±±â€”â€”äººå·¥æ™ºèƒ½å…¬å¸OpenAIä»Šå¤©æ­£å¼å‘å¸ƒäº†å…¶æœ€æ–°çš„å¤§è¯­è¨€æ¨¡å‹GPT-5ã€‚
CEO Sam Altmanåœ¨å‘å¸ƒä¼šä¸Šè¡¨ç¤ºï¼ŒGPT-5åœ¨æ¨ç†èƒ½åŠ›å’ŒçŸ¥è¯†å‡†ç¡®æ€§ä¸Šæœ‰äº†æ˜¾è‘—æå‡ã€‚

å¾®è½¯ä½œä¸ºOpenAIçš„ä¸»è¦æŠ•èµ„æ–¹ï¼Œå°†é¦–å…ˆåœ¨å…¶Azureäº‘å¹³å°ä¸Šæä¾›GPT-5çš„APIæœåŠ¡ã€‚
è°·æ­Œå’ŒMetaç­‰ç«äº‰å¯¹æ‰‹æ­£åœ¨åŠ ç´§ç ”å‘è‡ªå·±çš„ä¸‹ä¸€ä»£æ¨¡å‹ã€‚

åˆ†æäººå£«è®¤ä¸ºï¼Œè¿™ä¸€å‘å¸ƒå°†åŠ é€ŸAIåœ¨åŒ»ç–—ã€æ•™è‚²å’Œç§‘ç ”é¢†åŸŸçš„åº”ç”¨ã€‚""",
    "review": """æœ€è¿‘ä¹°äº†è¿™æ¬¾æ— çº¿è€³æœºï¼Œç”¨äº†ä¸€å‘¨æ¥è¯´è¯´æ„Ÿå—ã€‚

éŸ³è´¨æ–¹é¢ç¡®å®ä¸é”™ï¼Œä½éŸ³å¾ˆæœ‰åŠ›ï¼Œå¬æ­Œå¾ˆäº«å—ã€‚é™å™ªæ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œåœ°é“ä¸ŠåŸºæœ¬å¬ä¸åˆ°å¤–ç•Œå™ªéŸ³ã€‚

ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ä¸æ»¡æ„çš„åœ°æ–¹ã€‚é¦–å…ˆä»·æ ¼åè´µï¼Œ1599çš„å®šä»·æ„Ÿè§‰æœ‰ç‚¹è™šé«˜ã€‚å…¶æ¬¡ç»­èˆªä¸€èˆ¬ï¼Œå®˜æ–¹è¯´8å°æ—¶ï¼Œå®é™…å¼€é™å™ªçš„è¯ä¹Ÿå°±5-6å°æ—¶ã€‚

ä½©æˆ´èˆ’é€‚åº¦è¿˜å¯ä»¥ï¼Œé•¿æ—¶é—´ä½©æˆ´ä¸ä¼šè€³æœµç–¼ã€‚APPåŠŸèƒ½æ¯”è¾ƒä¸°å¯Œï¼Œå¯ä»¥è‡ªå®šä¹‰EQã€‚

æ€»çš„æ¥è¯´ï¼Œå¦‚æœé¢„ç®—å……è¶³ï¼Œè¿˜æ˜¯å€¼å¾—è´­ä¹°çš„ã€‚æ¨èç»™å¯¹éŸ³è´¨æœ‰è¦æ±‚çš„æœ‹å‹ã€‚""",
}


def save_result(data: dict, mode: str) -> Path:
    """ä¿å­˜æå–ç»“æœ"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"{mode}_{timestamp}.json"
    filepath = OUTPUT_DIR / filename

    with open(filepath, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

    return filepath


def main():
    """ä¸»å‡½æ•°"""
    Display.header()

    # åˆå§‹åŒ–æå–å™¨
    try:
        extractor = LangChainExtractor()
        Display.info("LangChain æå–å™¨åˆå§‹åŒ–æˆåŠŸ")
    except Exception as e:
        Display.error(f"åˆå§‹åŒ–å¤±è´¥: {e}")
        sys.exit(1)

    while True:
        # 1. é€‰æ‹©æ¨¡å¼
        options = [f"{emoji} {name}" for _, emoji, name in MODES]
        choice = Display.menu(options, "é€‰æ‹©æå–æ¨¡å¼")
        if choice == -1:
            Display.info("æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼ğŸ‘‹")
            break

        mode_key, mode_emoji, mode_name = MODES[choice]

        # 2. è·å–è¾“å…¥æ–‡æœ¬
        console_msg = f"è¯·è¾“å…¥{mode_name.split()[0]}æ–‡æœ¬"

        # æä¾›ä½¿ç”¨ç¤ºä¾‹çš„é€‰é¡¹
        use_example = input(f"\nä½¿ç”¨ç¤ºä¾‹æ–‡æœ¬? [y/N]: ").strip().lower() == "y"

        if use_example:
            text = EXAMPLES.get(mode_key, "")
            print(f"\n[ç¤ºä¾‹æ–‡æœ¬]\n{text[:200]}...")
        else:
            text = Display.multiline_input(console_msg)

        if not text.strip():
            Display.error("è¾“å…¥ä¸èƒ½ä¸ºç©º")
            continue

        # 3. æ‰§è¡Œæå–
        Display.loading()
        try:
            result = extractor.extract_to_dict(text, mode_key)
        except Exception as e:
            Display.error(f"æå–å¤±è´¥: {e}")
            continue

        # 4. æ˜¾ç¤ºç»“æœ
        Display.show_json(result, f"{mode_emoji} {mode_name}")

        # 5. ä¿å­˜ç»“æœ
        filepath = save_result(result, mode_key)
        Display.success(f"å·²ä¿å­˜åˆ° {filepath}")


if __name__ == "__main__":
    main()
